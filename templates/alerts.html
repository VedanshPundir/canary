{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <div class="card border-0 shadow">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center rounded-top">
            <h5 class="mb-0 fw-bold" style="font-size: 1.5rem; font-family: 'Roboto', sans-serif;">
                <i class="fas fa-bell"></i> Triggered Alerts
            </h5>
            <a href="/clear-alerts" class="btn btn-danger btn-sm fw-medium" style="font-size: 0.9rem; font-family: 'Roboto', sans-serif;">
                <i class="fas fa-trash-alt"></i> Clear Alerts
            </a>
        </div>
        <div class="card-body p-0">
            {% if alerts %}
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle" style="font-size: 0.95rem; font-family: 'Inter', sans-serif;">
                    <thead class="table-light">
                        <tr class="fw-semibold" style="font-size: 1rem; background-color: #f8f9fa;">
                            <th><i class="far fa-clock"></i> Timestamp</th>
                            <th><i class="fas fa-key"></i> Token</th>
                            <th><i class="fas fa-network-wired"></i> IP</th>
                            <th><i class="fas fa-map-marker-alt"></i> Location</th>
                            <th><i class="fas fa-laptop-code"></i> User Agent</th>
                            <th><i class="fas fa-map"></i> Map</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for alert in alerts %}
                        <tr>
                            <td class="text-muted" style="white-space: nowrap; font-size: 0.9rem;">{{ alert.timestamp }}</td>
                            <td><code class="text-primary" style="font-size: 0.9rem; font-family: 'Fira Code', monospace;">{{ alert.token }}</code></td>
                            <td style="font-size: 0.9rem;">{{ alert.ip }}</td>
                            <td style="font-size: 0.9rem;">{{ alert.location or "Unknown" }}</td>
                            <td style="max-width: 250px; font-size: 0.9rem;">
                                <span class="d-inline-block text-truncate" style="max-width: 240px; font-family: 'Inter', sans-serif;" title="{{ alert.user_agent }}">
                                    {{ alert.user_agent }}
                                </span>
                            </td>
                            <td>
                                {% if alert.latitude and alert.longitude %}
                                <a href="/map?lat={{ alert.latitude }}&lon={{ alert.longitude }}" target="_blank" class="btn btn-outline-primary btn-sm fw-medium" style="font-size: 0.85rem; font-family: 'Roboto', sans-serif;">
                                    <i class="fas fa-map-marked-alt"></i> Map
                                </a>
                                {% else %}
                                <span class="text-muted" style="font-size: 0.9rem;">N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info m-3 text-center" style="font-size: 1rem; font-family: 'Inter', sans-serif;">
                <i class="fas fa-info-circle"></i> No alerts triggered yet.
            </div>
            {% endif %}
        </div>
    </div>
</div>
<audio id="alertSound" src="{{ url_for('static', filename='piece-of-cake-611.mp3') }}" preload="auto"></audio>

<script>
    let lastAlertCount = {{ alerts|length }};

    async function checkForNewAlerts() {
        try {
            const response = await fetch('/alerts-count');
            const data = await response.json();
            if (data.count > lastAlertCount) {
                const audio = document.getElementById("alertSound");
                audio.currentTime = 0;     // rewind to start
                audio.volume = 0.7;        // adjust volume (0.0 to 1.0)
                audio.play();
                lastAlertCount = data.count;
                location.reload();         // refresh to show alert
            }
        } catch (err) {
            console.error("Error checking alerts:", err);
        }
    }

    setInterval(checkForNewAlerts, 10000); // Check every 10 seconds
</script>

{% endblock %}
